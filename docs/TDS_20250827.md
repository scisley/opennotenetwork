# Core Technical Design Specification (TDS v1)

Climate-focused Community Notes system for X.com — Proof of Concept

> Scope: End-to-end pipeline and web app per PRD. The fact-checking agent itself is a black box implemented separately. This TDS defines stable contracts, data model, backend APIs, UI states, and failure handling to enable implementation.

---

## 1) System Architecture Overview

### 1.1 Components (Single FastAPI App)

- **FastAPI App (monolith)** running on Fly.io (tentative):

  - **Public Router**: read-only endpoints for submitted/accepted notes.
  - **Admin Router**: authenticated endpoints for review, edit, regenerate, rerun classification, submit, and _ingestion/reconciliation triggers_.
  - **Services (in-process modules)**

    - `services.ingestion` — fetches X’s requested Community Notes feed and persists posts **with deduplication**.
    - `services.classifier` — classifies posts into one or more topics using the active classifier; supports rerun.
    - `services.notegen` — calls the external fact-checking agent (LangGraph-based) to produce **two outputs** per draft: (a) a full-length fact check and (b) a concise Community Note that follows the active platform policy (e.g., for X: ≤280 chars (URLs may count as one) and includes a link back to the canonical note page); supports regeneration with version tagging.
    - `services.submission` — sends approved notes to X’s Community Notes API and reconciles outcomes.

  - **External Scheduler (preferred for PoC)**: a single GitHub Actions (or similar cron) workflow **calls the Admin ingest endpoint and then the reconciliation endpoint** on each run; no in-process scheduler required.
  - **DB Layer**: SQLAlchemy models + repository.

- **Web Frontend (Next.js on Vercel)**: Single app with a **unified Note Detail page** and an **admin-only edit/submit widget**. No caching for v1 (fully dynamic render).
- **PostgreSQL (Neon)**: Primary data store.

### Architecture & Repo

- Repo layout: Monorepo with /api (FastAPI) + /web (Next.js) + /infra (GH Actions, Fly).
- Language/tooling: TypeScript strict for web; Python 3.11+ for API; Ruff/Black + mypy (lenient).

### 1.2 Communication

- **In-process function calls** between routers and services (no internal HTTP).
- External HTTP only to: X APIs, Clerk (hosted auth), and the LangGraph agent endpoint for note generation.

### 1.3 Security & Auth

- **Public site**: no auth (read-only endpoints).
- **Admin**: Google OAuth (or similar). Backend validates session and role (`admin`).

---

## 2) Data Model & Database Schema

### 2.1 Entities

- **users** — admin identities & roles.
- **platforms** — registry of supported social media platforms (e.g., X). Minimal: `platform_id`, `display_name`, `config` (optional), `status`, and `created_at`.
- **posts** — ingested posts from a platform. Primary key `post_uid` = "--\<platform_post_id>".
- **post_topics** — many-to-many mapping between posts and topics, including confidence and classifier version.
- **topics** — list of supported topics (e.g., climate, us_politics, crypto); includes optional `config` JSONB for per-topic settings.
- **draft_notes** — AI-generated note drafts (multiple versions/regenerations per post), linked to a specific topic; each draft stores a **full-length fact check** and a **concise ≤280‑character note** (the concise note must include at least one link back to the hosted full fact check page).
- **submissions** — submissions sent to X (one per approved draft), including current decision status and decision timestamp (e.g., `decided_at`).

### 2.2 ID Conventions

- `post_uid = lower(platform) + '--' + platform_post_id` (not enforced by DB, but validated in application and used across APIs & UIs for human readability and cross-platform uniqueness).
- Keep `platform_post_id` intact (string) so we can call back to the native API without lossy conversions (e.g., 64-bit ints, non-numeric ids).

#### Helpers (canonical functions)

- `build_post_uid(platform: str, platform_post_id: str) -> str` ⇒ `f"{platform.lower()}--{platform_post_id}"`
- `parse_post_uid(post_uid: str) -> tuple[platform: str, platform_post_id: str]` ⇒ split on `"--"`, left part lowercased.
- Validation rule (app-level): `parse_post_uid(post_uid).platform == posts.platform`.

### 2.3 Status Enums

- **draft_status**: `draft`, `approved`, `submitted`, `superseded`.
- **submission_status**: `submitted`, `accepted`, `rejected`, `unknown`.

### 2.4 Suggested Table Definitions (DDL sketch)

```sql
CREATE TABLE users (
  user_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email TEXT UNIQUE NOT NULL,
  display_name TEXT,
  role TEXT NOT NULL CHECK (role IN ('admin','viewer')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE platforms (
  platform_id TEXT PRIMARY KEY,
  display_name TEXT NOT NULL,
  config JSONB,
  status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active','archived')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);


CREATE TABLE posts (
  post_uid TEXT PRIMARY KEY,
  platform TEXT NOT NULL REFERENCES platforms(platform_id),
  platform_post_id TEXT NOT NULL,
  author_handle TEXT,
  text TEXT NOT NULL,
  raw_json JSONB,
  created_at TIMESTAMPTZ,
  ingested_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  last_error TEXT,
  classified_at TIMESTAMPTZ,
  CONSTRAINT post_uid_platform_consistent CHECK (split_part(post_uid, '--', 1) = platform)
);

CREATE TABLE topics (
  topic_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  slug TEXT UNIQUE NOT NULL,
  display_name TEXT NOT NULL,
  config JSONB,
  status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active','archived')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE post_topics (
  post_uid TEXT NOT NULL REFERENCES posts(post_uid) ON DELETE CASCADE,
  topic_id UUID NOT NULL REFERENCES topics(topic_id) ON DELETE CASCADE,
  labeled_by TEXT NOT NULL CHECK (labeled_by IN ('classifier','admin')),
  confidence NUMERIC(3,2),
  classifier_version TEXT,
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  PRIMARY KEY (post_uid, topic_id)
);


CREATE TABLE draft_notes (
  draft_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  post_uid TEXT NOT NULL REFERENCES posts(post_uid) ON DELETE CASCADE,
  topic_id UUID REFERENCES topics(topic_id),
  full_body TEXT NOT NULL,                           -- full-length fact check
  concise_body TEXT NOT NULL,                        -- concise Community Note (policy-driven length/requirements)
  citations JSONB,
  generator_version TEXT,
  generated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  regenerated_from UUID REFERENCES draft_notes(draft_id),
  draft_status TEXT NOT NULL DEFAULT 'draft' CHECK (draft_status IN ('draft','approved','submitted','superseded')),
  edited_by UUID REFERENCES users(user_id),
  edited_at TIMESTAMPTZ
);

CREATE TABLE submissions (
  submission_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  post_uid TEXT NOT NULL REFERENCES posts(post_uid) ON DELETE CASCADE,
  draft_id UUID NOT NULL REFERENCES draft_notes(draft_id),
  x_note_id TEXT,
  submission_status TEXT NOT NULL DEFAULT 'submitted' CHECK (submission_status IN ('submitted','accepted','rejected','unknown')),
  submitted_by UUID REFERENCES users(user_id),
  submitted_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  response_json JSONB,
  CONSTRAINT submissions_one_per_draft UNIQUE (draft_id)
);


-- Helpful indexes
CREATE INDEX idx_posts_platform_platform_id ON posts(platform, platform_post_id);
CREATE INDEX idx_post_topics_post ON post_topics(post_uid);
CREATE INDEX idx_post_topics_topic ON post_topics(topic_id);
CREATE INDEX idx_draft_notes_post ON draft_notes(post_uid);
CREATE INDEX idx_submissions_post ON submissions(post_uid);
CREATE INDEX idx_submissions_status ON submissions(submission_status);
```

---

## 3) Backend APIs (FastAPI Contracts)

> All write endpoints require admin role protection. Critical write actions are idempotent at the application level. All list endpoints use `limit` and `offset` for pagination; cursors are not used in v1.

### 3.1 Public API (read-only)

- `GET /api/public/notes?status=submitted|accepted&limit=50&offset=0` → Returns list of notes with minimal post context and citations.
- `GET /api/public/notes/{post_uid}` → Returns submitted/accepted note(s) for a post.

### 3.2 Admin API

- **Ingestion**

  - `POST /api/admin/ingest` → Runs ingestion for a fixed lookback window (e.g., last 24 hours); deduplicates by `post_uid`. Returns { added, skipped }.
  - Endpoint is used by external scheduler (GitHub Actions) and by manual admin trigger.

- **Classification**

  - `POST /api/admin/posts/{post_uid}/classify` → runs classifier; upserts rows in `post_topics`.
  - `POST /api/admin/posts/{post_uid}/classify:rerun` { `version` } → reruns classification; updates `post_topics` rows (no history).
  - Admin overrides:

    - `POST /api/admin/posts/{post_uid}/topics` { `topic_slug`, `confidence` } → manual label (labeled_by='admin').
    - `DELETE /api/admin/posts/{post_uid}/topics/{topic_slug}` → remove label.

- **Draft Generation**

  - `POST /api/admin/posts/{post_uid}/drafts` { `topic_slug`, `regenerate` } → generate a draft with both `full_body` and `concise_body`; the concise note must satisfy the **current platform policy** (e.g., for X: ≤280 chars and must contain a link).
  - `POST /api/admin/drafts/{draft_id}:regenerate` { `version` } → regenerate; links to previous; prior set `superseded`.
  - `PATCH /api/admin/drafts/{draft_id}` { `full_body`, `concise_body`, `citations` } → edit draft content.
  - `POST /api/admin/drafts/{draft_id}:approve` → validates constraints (concise length ≤280 and contains at least one `http(s)://` link, typically to the canonical note page at `/notes/{post_uid}`) and marks approved.

- **Submission**

  - `POST /api/admin/drafts/{draft_id}:submit` → submits the concise note to X; server-side dedup ensures only one submission per draft and returns the existing submission if called again; stores response.

- **Reconciliation**

  - `POST /api/admin/submissions/reconcile` → polls X for outcomes and updates DB; scans pending submissions (status `submitted` or `unknown`) and returns counts { checked, updated, unchanged }.
  - Endpoint is used by an external scheduler on a regular cadence and may be called manually by admins.

### 3.3 Internal Service Interfaces (in-process)

- `services.classifier.run(post_uid, version=None) -> list[TopicLabel]`

  - TopicLabel = { topic_slug, confidence, classifier_version }

- `services.notegen.generate(post_uid, topic_slug=None, version=None) -> DraftResult`
- `services.submission.submit(draft_id) -> SubmissionResult`
- `services.submission.reconcile() -> int`

### 3.4 Idempotent Behavior & Deduplication

- Ingestion: idempotent via upserts; repeated calls safely no-op except for new items.
- Submission: idempotent at the application level. The server enforces **one submission per draft** and returns the existing submission record on repeat calls (e.g., double‑clicks, retries). Row-level locks prevent races.
- Reconciliation: safe to run repeatedly; only changes items whose status has evolved; no-ops otherwise.

---

## 4) Ingestion, Submission & Reconciliation (Monolith)

### 4.1 Ingestion

- Triggered by external scheduler (single GitHub Actions workflow every 6h) or manually.
- Uses a fixed lookback window; deduplicates via `post_uid` unique constraint.
- Returns counts {added, skipped}.

#### Example GitHub Actions Workflow

```yaml
name: Ingest & Reconcile Notes

on:
  schedule:
    - cron: "0 */6 * * *" # every 6 hours

jobs:
  ingest_reconcile:
    runs-on: ubuntu-latest
    steps:
      - name: Ingest recent posts
        run: |
          curl -X POST "${{ secrets.API_BASE_URL }}/api/admin/ingest" \
            -H "Content-Type: application/json" \
            -H "X-INGEST-SECRET: ${{ secrets.INGEST_SECRET }}" \
            -d '{}'
      - name: Reconcile submission outcomes
        run: |
          curl -X POST "${{ secrets.API_BASE_URL }}/api/admin/submissions/reconcile" \
            -H "Content-Type: application/json" \
            -H "X-RECONCILE-SECRET: ${{ secrets.RECONCILE_SECRET }}" \
            -d '{}'
```

### 4.3 Reconciliation

- Runs on a schedule (e.g., every 6 hours) and on-demand from the Admin UI.
- Scans submissions with status `submitted` or `unknown`, queries X for decisions, and updates `submissions.submission_status` and sets `decided_at` when decisions are present.
- Safe to run frequently; handles long evaluation delays by repeatedly checking pending items.

#### Example GitHub Actions Workflow

Handled by the combined **Ingest & Reconcile Notes** workflow shown above.

### 4.2 Submission

- Maps internal draft to X note submission using the **concise note** that meets the platform policy (for X: ≤280 and includes a link).
- Stores request/response JSON.
- Reconciliation job polls X and updates submission records.

---

## 5) Frontend (Next.js)

### 5.1 Unified Note Detail (public view + admin widget)

- **Route:** `/notes/{post_uid}`
- **Always visible (public):**

  - Tweet embed (standard X widget)
  - Concise note (if present) with visible citations
  - Full fact check (rendered from `full_body`) with citations and link to original post

- **Admin-only widget (role = admin):**

  - Docked panel with tabs: **Full Fact Check** and **Concise Note**
  - Live character counter for concise note (policy-aware for the active platform)
  - Actions: Generate/Regenerate, Save (`PATCH`), Approve, Submit, Reconcile now (if submitted)
  - Timeline of regenerations (previous drafts, supersession)
  - Validation shown inline; “Approve & Submit” disabled until valid

**Implementation simplicity:**

- Render the page **dynamically** (no caching/ISR). Keep the admin widget simple; it may render client-side after auth is detected.
- Data fetching: public content via `GET /api/public/notes/{post_uid}` ; admin metadata/drafts via `GET /api/admin/posts/{post_uid}`.

### 5.2 Other screens (admin-only)

- **Queue view:** triage of ingested/classified posts and a **Ingest now** action.
- **Submissions dashboard:** list with statuses and a **Reconcile now** action.

## 6) AuthN/AuthZ

Clerk for admin login; roles checked from Clerk (org role or user metadata) on the backend.

---

## 7) Error Handling, Retries, Concurrency

### 7.1 Content Validation Rules (server-side)

- Rules should be encapsulated in platform logic. Below are the requirements for the X platform.

  - `concise_body` must be ≤ 280 characters (URLs count as a single character; enforced by API validation).
  - `concise_body` must contain at least one `http(s)://` link; by default this should be the public URL of the full fact check page at `/notes/{post_uid}`.

- Approval and submission endpoints re-validate these constraints; violations return 422 with details.

- Failures stored in `last_error` on posts.

- Exponential backoff for transient errors.

---

## 8) Versioning Model

- No global `versions` table in v1.
- Store version strings inline:

  - `post_topics.classifier_version` (latest only).
  - `draft_notes.generator_version`.

- Draft regenerations create new rows; prior drafts marked `superseded`.
- Classification history is not stored (only the latest labels are kept).

## 9) Configuration & Secrets

- Environment vars: DB URL, Clerk publishable key/secret, issuer/JWKS URL (if verified manually), and one cron HMAC key, X API creds, classifier/notegen URLs, ingest secret, reconcile secret.

---

## 10) Extensibility

- Platforms: new rows in `platforms` table.
- Topics: new rows in `topics`.
- Swappable classifier/generator via `versions` + config.

---

## 11) Non-Goals / Out of Scope

- Automated evaluator integration.
- Advanced analytics.
- CI/CD, monitoring, observability.

---

## 12) Definition of Done

- End-to-end ingestion → classification → draft (full + concise) → edit/approve → submit → reconciliation works.
- Admin can regenerate notes (draft history kept) and rerun classification (post_topics updated in-place).
- **Concise note validations enforced**: ≤280 characters and contains at least one link (preferably to the hosted full fact check).
- Public site shows the full fact check on the unified note page and shows submitted/accepted notes with filters.
- Auth works with Clerk (admin-only actions require a valid Clerk JWT)
- Deduplication and idempotency working.

# 13) Library & Integration Plan (WIP-Friendly)

## Frontend

- **Query/cache:** **TanStack Query v5 (React Query)** for list/detail views and mutate→invalidate flows (draft save, approve, submit, reconcile). Use `staleTime` and `gcTime` tuned for admin work; prefer `useMutation` with optimistic updates on draft edits.
- **Typed API client:** Generate types and hooks from the OpenAPI spec:

  - **orval** (preferred) to emit **Axios + React Query hooks**

- **Tables & large lists:** **TanStack Table** + **@tanstack/react-virtual** for queue-like screens with smooth scrolling and column controls.
- **Forms & validation:** **react-hook-form** + **zod** (+ `@hookform/resolvers/zod`). Enforce platform-facing constraints at the schema layer (e.g., concise note length; at least one `https://` citation). Surface friendly inline errors before submit.
- **UI & styling:** **Tailwind CSS** + **shadcn/ui** + **lucide-react** for fast, consistent components (Buttons, Inputs, Dialogs, Tabs).
- **Editing experience:**

  - **Concise note:** lightweight textarea with live character counter and simple link detector.
  - **Full fact-check draft:** **@uiw/react-md-editor** (edit) + **react-markdown** (render) with `remark-gfm`; sanitize render with `rehype-sanitize`.

- **Embed support:** Use X/Twitter widgets script on the unified note page to render the original post; lazy-load the script via Next.js `<Script>` to avoid blocking.
- **Pagination UX:** Use limit/offset from the API; apply `keepPreviousData` for smooth page switches and preserve row selection where possible.

## Backend

- **HTTP & retries:** **httpx.AsyncClient** for outbound requests; wrap calls with **tenacity** (exponential backoff, jitter) for X API and agent calls.
- **Auth (admin):**

Clerk gives us fully hosted auth for the Next.js admin UI—drop-in sign-in/SSO, sessions, and role-aware gating via middleware with almost no custom code. The frontend forwards a Clerk-issued JWT on API calls, and the FastAPI backend verifies it with fastapi-clerk-auth to enforce admin-only endpoints.

- Frontend libraries: @clerk/nextjs (core auth + hosted UI), optional @clerk/themes (styling for Clerk components).
- Backend libraries: fastapi-clerk-auth (Clerk JWT verification via JWKS for FastAPI), optional fallback PyJWT (or python-jose) + httpx if doing manual verification later.

Enforce admin authorization by checking a stable claim (either org_role or a custom public_metadata.roles array exposed by the backend JWT template).

- **OpenAPI-first contracts:** Treat FastAPI’s OpenAPI as the source of truth; add precise response models for list endpoints (items + total). Publish a stable `openapi.json` path for codegen.
- **Scheduling (externalized):** Use **GitHub Actions** cron workflows to call ingestion/reconciliation endpoints with a bearer token. Keep no in-process job runner; treat endpoints as idempotent.
- **Validation & platform rules:** Centralize platform-specific checks (concise note length, required link, allowed domains if needed) in a dedicated service used by both “preview” and “submit” paths. Return 422 with structured error codes the UI can map to form messages.
- **Observability:** **structlog** for structured logs in logfmt/JSON; include request id, actor id, and endpoint latency. Add middleware to inject a `request_id` header if missing.
- **CORS & security basics:** Starlette CORS middleware (restrict origin to the admin UI host); strict cookie attributes; content security policy for the admin app to limit third-party scripts.

## Dev Workflow & DX

- **Client/server sync:** Add a small script/CI step to regenerate TS types/hooks from `openapi.json` on backend changes; commit generated clients to keep the admin UI reproducible.
- **Local data without migrations:** In dev, create tables via ORM metadata or a one-shot SQL script; wipe-and-recreate is acceptable until launch. Defer migration tooling and versioning to the production hardening phase.
- **Quality gates:**

  - Backend: **ruff** (lint), **black** (format), **mypy** (types).
  - Frontend: **eslint** + **typescript** strict mode.
  - Pre-commit hooks to enforce formatting/typing before push.

## Small implementation notes

- Prefer **idempotency keys** (e.g., `X-Idempotency-Key`) on submission endpoints to guard against double-submits from the UI or scheduler retries.
- Standardize error shapes: `{ code, message, details? }` so the UI can map server errors to user-facing toasts and field errors deterministically.
- For long-running agent calls, return a **202 Accepted** with a polling token; the UI can poll a status endpoint via React Query with exponential backoff.

---

If you want, I can convert this section into a PR and append it to the TDS file verbatim.
